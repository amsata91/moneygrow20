---
title: "  Pojet receuil de données"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Introduction 
Shiny, c'est un package R qui facilite la construction d'applications web interactives depuis R. Les utilisateurs peuvent simplement manipuler une application "clique- boutons" pour exécuter et afcher des résultats fournis par du code R. \
Dans ce projet nous allons pratiquer un peu de Rshiny, en explorant les données de la série Game of thrones. Pour faire nous allons nous  basé sur les TPs faites en classe pour déveloper plusieurs.\

```{r ,echo=FALSE,message=FALSE}
library(shiny)
library(tidyverse)
library(tidyr)
library(dplyr)
library(sf)
library(ggplot2)
library(DT)
library(readr)
library(cartography)

load("amsa.RData")

```


```{r, echo=FALSE,message=FALSE}
load("got_data.RData")
load("got.RData")
# Define UI for dataset viewer app ----
ui = fluidPage(

  titlePanel("Importation des données et visualisation de leurs structures"),
  sidebarLayout(
    sidebarPanel(
      selectInput("dataset", "Choisir un dataset:",
                  choices = c("appearences","characters", "episodes","scenes")),
      numericInput("obs", "Nombre d'observation :", 10),
      tags$h5("actionButton:"),
      actionButton("update", "Action button", class = "btn-primary"),
      p("Click sur bouton pour visualiser tes données"),
      tags$h5("Téléchargement des données"),
      downloadButton("downloadData", "Download")

    ),

  
    mainPanel(
      tabsetPanel(
        tabPanel("Dataset",
                 h4("Observation"),
                 tableOutput("view")),
        tabPanel("Dataset View",
                 h4("Observation View"),
                 DT::dataTableOutput('view1')),
        tabPanel("Summary",
                 h4("Summary"),
                 verbatimTextOutput("summary")),
        tabPanel("str",
                 h4("str"),
                 verbatimTextOutput("str")),
         tabPanel("Etude du dataset Scenes",
                 h4("Le nombre de personnages morts de la serie"),
                 verbatimTextOutput("nbth"),
                 h4("Le nombre de personnages morts lors de la première saison"),
                 verbatimTextOutput("nbsaison"),
                 h4("La durée de la scène la plus longue et l’id de l’episode "),
                 verbatimTextOutput("dur")),
        tabPanel("Visualisation morts cum",
                 h4("visualisation des morts cumulés"),
                 plotOutput("cum"))
        
      )
    )

  )
)
server = function(input, output) {
  datasetInput = eventReactive(input$update, {
    switch(input$dataset,
           "appearences"=appearences,
           "characters"=characters,
           "episodes"=episodes,
           "scenes"=scenes)
  }, ignoreNULL = FALSE)
  output$view = renderTable({
    head(datasetInput(), n = isolate(input$obs))
  })
  output$view1 = DT::renderDataTable(
    DT::datatable(datasetInput(), options = list(pageLength = 25))
  )
  output$summary = renderPrint({
    dataset = datasetInput()
    summary(dataset)
  })
  output$view = renderTable({
    head(datasetInput(), n = isolate(input$obs))
  })
  output$str = renderPrint({
    dataset = datasetInput()
    str(dataset)
  })
  output$nbth = renderPrint({
    dataset = datasetInput()
    if(dataset==scenes){
      sum(dataset$nbdeath)
    }
    else{
     output$nbth = print("Vous devez choisir le dataset scenes pour connaitre le nombre #de morts")
    }
  })
  output$nbsaison = renderPrint({
    dataset = datasetInput()
    if(dataset==scenes){
     sum(dataset$nbdeath[dataset$episodeId<=10])
    }
  })
  output$dur = renderPrint({
    dataset = datasetInput()
    if(dataset==scenes){
      dataset[which.max(dataset$duration),]
     
    }
  })
  output$cum = renderPlot({
    # nombre de morts cumulé et temps passé
    deaths = scenes %>% select(nbdeath,duration,location,episodeId) %>%
      mutate(t=cumsum(duration),tdeath=cumsum(nbdeath))
    # instant de changement de saison
    # ? lag
    season_t = episodes %>% mutate(ld=lag(total_duration)) %>%
      mutate(ld=if_else(is.na(ld),0,ld), td = cumsum(ld)) %>% 
      filter(episodeNum==1) %>% pull(td)# nombre de morts cumulé et temps passé
    # geom_line + labels personalisés
    ggplot(deaths) + geom_line(aes(x=t/3600,y=tdeath)) +
      scale_x_continuous("",expand = c(0,0),breaks = season_t/3600,
                     labels =   paste("Saison",1:8),)+
      scale_y_continuous("Nombre de morts cumulés", expand=c(0,0))+
      theme_bw()+theme(axis.text.x=element_text(angle=90))+
      ggtitle("Evolution du nombre de mort au cours du temps")
  })
   # Downloadable csv of selected dataset ----
  output$downloadData = downloadHandler(
    filename = function() {
      paste(input$dataset, ".csv", sep = "")
    },
    content = function(file) {
      write.csv(datasetInput(), file, row.names = FALSE)
    }
  )

}

shinyApp(ui, server)
```









# Partie 2



```{r, echo=FALSE,cache=FALSE, results=FALSE, message=FALSE, comment=FALSE, warning=FALSE}

```



```{r, echo=FALSE,message=FALSE}
library(dplyr)
load("got_data.RData")
load("myfile.RData")
colforest="#c0d7c2"
colriver="#7ec9dc"
colland="ivory"
borderland = "ivory3" 
character_name_list = appearences %>% pull(name) %>% unique()
ui = tagList(
    shinythemes::themeSelector(),
    navbarPage(
      # theme = "cerulean",  # <--- To use a theme, uncomment this
      "Exploitation des données",
      tabPanel("Etude 1",
        sidebarPanel(
          selectInput("charactername", "Character name:",character_name_list),
          tags$h5("actionButton with CSS class:"),
          actionButton("action", "Action button", class = "btn-primary")
        ),
        mainPanel(
          tabsetPanel(
            tabPanel("L'episode plus visible",
              h4("L’épisode ou le personnage selectionné a le plus longtemps visible de la serie."),
              verbatimTextOutput("txtout")
            ),
            tabPanel("Visualisation de temps de présent",
                     h4(""),
                     plotOutput("maplot")),
            tabPanel("Geolocalisation ",
                     h4(""),
                     plotOutput("mapplot",height="400px"))
          )
        )
      ),
      tabPanel("Etude 2", "This panel is intentionally left blank"),
      tabPanel("Etude 3", "This panel is intentionally left blank")
 ))
server = function(input, output) {
    output$txtout = renderPrint({
     appearances %>%filter(name==input$charactername) %>% 
        left_join(scenes) %>% left_join(episodes) %>%
        group_by(name,episodeId,episodeTitle) %>% 
        summarise(screenTime=sum(duration)) %>% 
        arrange(desc(screenTime)) %>% head(1)
    })
    output$maplot = renderPlot({
      
      jstime = appearances %>% filter(name==input$charactername) %>% 
        left_join(scenes) %>% 
        group_by(episodeId) %>% 
        summarise(time=sum(duration))
    ggplot(jstime) + 
      geom_line(aes(x=episodeId,y=time))+
      theme_bw()+
      xlab("épisode")+ylab("temps")+
      ggtitle("Temps de présence par épisode ")
    })
    output$mapplot = renderPlot({
 

        landpol = st_union(st_geometry(land))
        islandpol = st_union(st_geometry(islands))
        backpol=st_union(landpol,islandpol)
        background = st_as_sf(backpol)
 
       loc_time= appearances %>% filter(name %in% input$chartername) %>%
                 left_join(scenes) %>%
            group_by(location,input$chartername) %>%
         summarize(duration=sum(duration,na.rm=TRUE))
        loc_time_mc = scenes_locations %>% left_join(loc_time)
 
   
       ggplot()+geom_sf(data=background,color="ivory3" ,fill="ivory")+
       geom_sf(data=loc_time_mc%>% filter(!is.na(duration)),aes(size=duration))+
       geom_sf_text(data=loc_time_mc,aes(label=location),color="#000000",vjust="bottom",family="CM Roman", fontface="italic")+
       coord_sf(expand = 0, ndiscr = 0)+
       
       scale_size_area("Duree (seconde) :",max_size =
                         8,breaks=c(30,60,120,240,480,500,600))+
       theme(panel.background = element_rect(fill = "#87cdde",color=NA),
      text = element_text(family="CM Roman",face = "bold",size = 12),
      legend.key = element_rect(fill="#ffffff"))+
       labs(title = "Temps de presence des personnage ",
         caption = "",x="",y="")

    })
 
  }

shinyApp(ui, server)

```